<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MarquesaBot - Tu Asistente de Repostería</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f7fafc;
        }
        .chat-container {
            max-width: 600px;
            margin: 20px auto;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            background-color: #ffffff;
        }
        .header {
            background-color: #a78bfa; /* Un morado suave */
            color: white;
            padding: 1rem;
            text-align: center;
            font-size: 1.5rem;
            font-weight: bold;
        }
        .messages {
            padding: 1rem;
            min-height: 400px;
            max-height: 60vh; /* Ajusta la altura máxima para que sea responsive */
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            background-color: #edf2f7;
        }
        .user-message {
            background-color: #bfdbfe; /* Azul claro para el usuario */
            color: #1a202c;
            align-self: flex-end;
            padding: 0.6rem 1rem;
            border-radius: 15px 15px 0 15px;
            max-width: 75%;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        .bot-message {
            background-color: #ffffff; /* Blanco para el bot */
            color: #2d3748;
            align-self: flex-start;
            padding: 0.6rem 1rem;
            border-radius: 15px 15px 15px 0;
            max-width: 75%;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        .input-area {
            display: flex;
            padding: 1rem;
            border-top: 1px solid #e2e8f0;
            background-color: #ffffff;
        }
        .input-area input {
            flex-grow: 1;
            padding: 0.75rem;
            border: 1px solid #cbd5e0;
            border-radius: 20px;
            margin-right: 0.5rem;
            font-size: 1rem;
        }
        .input-area button {
            background-color: #a78bfa; /* Morado del header */
            color: white;
            padding: 0.75rem 1.25rem;
            border-radius: 20px;
            font-weight: bold;
            transition: background-color 0.2s;
        }
        .input-area button:hover {
            background-color: #8b5cf6; /* Un morado más oscuro al pasar el ratón */
        }

        /* --- Estilos para el Carrusel de Imágenes --- */
        .carousel-container {
            position: relative;
            width: 100%;
            max-width: 500px; /* Ancho máximo para el carrusel */
            margin: 0 auto 1.5rem auto; /* Centrado y espacio inferior */
            overflow: hidden;
            border-radius: 15px; /* Bordes redondeados */
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
            background-color: #fff;
            padding: 10px; /* Espacio interno para que las imágenes no toquen el borde */
        }
        .carousel-image {
            width: 100%;
            display: block; /* Asegura que la imagen ocupe todo el ancho */
            border-radius: 10px; /* Bordes redondeados para cada imagen */
            transition: opacity 1s ease-in-out; /* Transición suave de opacidad */
            position: absolute; /* Para superponer las imágenes */
            top: 10px;
            left: 10px;
            opacity: 0; /* Por defecto invisibles */
            height: 300px; /* Altura fija para todas las imágenes */
            object-fit: cover; /* Recorta la imagen para que cubra el espacio */
        }
        .carousel-image.active {
            opacity: 1; /* La imagen activa es visible */
        }

        /* Estilos del modal de pago */
        .payment-modal {
            display: none; /* Oculto por defecto */
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.6);
            backdrop-filter: blur(5px);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background-color: #ffffff;
            margin: auto;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
            width: 90%;
            max-width: 450px;
            text-align: center;
            position: relative;
        }
        .close-button {
            color: #aaa;
            position: absolute;
            top: 10px;
            right: 20px;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .close-button:hover,
        .close-button:focus {
            color: #000;
            text-decoration: none;
            cursor: pointer;
        }
        .modal-content h2 {
            font-size: 1.8rem;
            color: #333;
            margin-bottom: 20px;
            font-weight: bold;
        }
        .payment-option {
            background-color: #f0f4f8;
            border: 1px solid #e2e8f0;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .payment-option:hover {
            background-color: #e6edf3;
            border-color: #a78bfa;
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
        }
        .payment-option img {
            max-width: 100px;
            height: auto;
            margin-bottom: 10px;
        }
        .payment-option strong {
            font-size: 1.2rem;
            color: #4a5568;
            margin-bottom: 5px;
        }
        .payment-option p {
            font-size: 0.9rem;
            color: #718096;
        }
        .qr-code-container {
            margin-top: 20px;
            display: none; /* Oculto por defecto */
        }
        .qr-code-container img {
            max-width: 200px;
            height: auto;
            border: 5px solid #a78bfa;
            border-radius: 10px;
            padding: 5px;
            background-color: #fff;
        }
        .qr-code-container p {
            font-size: 1rem;
            color: #4a5568;
            margin-top: 10px;
            font-weight: bold;
        }
    </style>
</head>
<body class="bg-gray-100 h-screen flex items-center justify-center">

    <div class="chat-container">
        <div class="header">
            MarquesaBot
        </div>
        <div class="messages" id="messages">
            <div id="image-carousel" class="carousel-container">
                </div>
            <div class="bot-message">
                ¡Hola! Soy MarquesaBot, tu asistente personal. Estoy aquí para presentarte la increíble guía "30 Recetas de Postres Fríos en Vasos". Con ella, podrás crear deliciosos postres y quizás iniciar tu propio emprendimiento. ¿Te gustaría saber más?
            </div>
        </div>
        <div class="input-area">
            <input type="text" id="user-input" placeholder="Escribe tu mensaje..." onkeypress="handleKeyPress(event)">
            <button onclick="sendMessage()">Enviar</button>
        </div>
    </div>

    <div id="paymentModal" class="payment-modal">
        <div class="modal-content">
            <span class="close-button" onclick="closePaymentModal()">&times;</span>
            <h2>¡Es hora de adquirir tu guía!</h2>
            <p>Selecciona tu método de pago preferido para obtener tu acceso a las 30 Recetas de Postres Fríos en Vasos por solo **35 Bs.**</p>

            <div class="payment-option" onclick="showQrCode('yape')">
                <img src="https://i.imgur.com/gK20mG1.png" alt="Logo QR Yape/BNB"> <strong>Pagar con QR (Yape Bolivia / BNB)</strong>
                <p>Escanea el código para completar tu compra.</p>
            </div>

            <div class="payment-option" onclick="payViaWhatsApp()">
                <img src="https://i.imgur.com/uRj0JmQ.png" alt="Logo WhatsApp">
                <strong>Pagar por WhatsApp</strong>
                <p>Te guiaremos para un pago directo y seguro.</p>
            </div>

            <div class="qr-code-container" id="qrCodeContainer">
                <img id="qrCodeImage" src="" alt="Código QR de Pago">
                <p>Escanea este código QR para realizar tu pago de 35 BOB.</p>
                <p>Una vez pagado, recibirás la guía en tu correo electrónico.</p>
            </div>
        </div>
    </div>

    <script>
        const API_ENDPOINT = 'https://kpbdtmtj2a6u7w75.supabase.co/functions/v1/asistente-ventas'; // Asegúrate de que esta URL sea correcta
        const messagesDiv = document.getElementById('messages');
        const userInput = document.getElementById('user-input');
        let chatHistory = [];

        // --- URLs de tus imágenes para el carrusel ---
        const imageUrls = [
            "https://i.imgur.com/XtgOBlm.png",
            "https://i.imgur.com/KUwUtOF.png",
            "https://i.imgur.com/wJ6J1z5.png",
            "https://i.imgur.com/Sc5OpA8.png",
            "https://i.imgur.com/akkjuyY.png",
            "https://i.imgur.com/5gltyFP.png",
            "https://i.imgur.com/pMxBfmC.png",
            "https://i.imgur.com/nP685Eb.png",
            "https://i.imgur.com/jUt7qZ8.png"
        ];
        let currentImageIndex = 0;
        const carouselContainer = document.getElementById('image-carousel');

        function initializeCarousel() {
            if (!carouselContainer) return;

            // Limpiar cualquier contenido anterior y establecer una altura inicial
            carouselContainer.innerHTML = '';
            carouselContainer.style.height = '320px'; // Altura del contenedor para evitar saltos

            imageUrls.forEach((url, index) => {
                const img = document.createElement('img');
                img.src = url;
                img.alt = `Postre frío ${index + 1}`;
                img.classList.add('carousel-image');
                if (index === 0) {
                    img.classList.add('active'); // La primera imagen es activa al inicio
                }
                carouselContainer.appendChild(img);
            });

            setInterval(nextImage, 5000); // Cambia de imagen cada 5 segundos
        }

        function nextImage() {
            const images = carouselContainer.querySelectorAll('.carousel-image');
            images[currentImageIndex].classList.remove('active');
            currentImageIndex = (currentImageIndex + 1) % images.length;
            images[currentImageIndex].classList.add('active');
        }

        // Llamar a la inicialización del carrusel cuando la página cargue
        document.addEventListener('DOMContentLoaded', initializeCarousel);


        async function sendMessage() {
            const message = userInput.value.trim();
            if (message === '') return;

            appendMessage(message, 'user-message');
            chatHistory.push({ role: 'user', content: message });
            userInput.value = '';

            try {
                // Deshabilitar input y botón mientras se espera respuesta
                userInput.disabled = true;
                document.querySelector('.input-area button').disabled = true;

                const response = await fetch(API_ENDPOINT, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ history: chatHistory })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Error al comunicarse con el bot.');
                }

                const data = await response.json();
                let botReply = data.reply;

                // --- Lógica para el [TRIGGER_PAGO] ---
                if (botReply.includes('[TRIGGER_PAGO]')) {
                    botReply = botReply.replace('[TRIGGER_PAGO]', '').trim(); // Eliminar el trigger del mensaje visible
                    if (botReply) { // Si queda algo de texto después del trigger, mostrarlo
                        appendMessage(botReply, 'bot-message');
                        chatHistory.push({ role: 'assistant', content: botReply });
                    }
                    showPaymentModal(); // Mostrar el modal
                } else {
                    appendMessage(botReply, 'bot-message');
                    chatHistory.push({ role: 'assistant', content: botReply });
                }
                // --- Fin de la lógica para el [TRIGGER_PAGO] ---

            } catch (error) {
                console.error('Error:', error);
                appendMessage('Lo siento, hubo un error al procesar tu solicitud: ' + error.message, 'bot-message');
                chatHistory.push({ role: 'assistant', content: 'Error' });
            } finally {
                // Volver a habilitar input y botón
                userInput.disabled = false;
                document.querySelector('.input-area button').disabled = false;
                userInput.focus();
                scrollToBottom();
            }
        }

        function appendMessage(text, type) {
            const messageElement = document.createElement('div');
            messageElement.classList.add(type);
            messageElement.innerHTML = text; // Usar innerHTML para interpretar negritas y otros formatos
            messagesDiv.appendChild(messageElement);
            scrollToBottom();
        }

        function scrollToBottom() {
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        // --- Funciones del Modal de Pago ---
        const paymentModal = document.getElementById('paymentModal');
        const qrCodeContainer = document.getElementById('qrCodeContainer');
        const qrCodeImage = document.getElementById('qrCodeImage');

        function showPaymentModal() {
            paymentModal.style.display = 'flex'; // Usar flex para centrar
            qrCodeContainer.style.display = 'none'; // Ocultar QR al abrir modal
        }

        function closePaymentModal() {
            paymentModal.style.display = 'none';
        }

        function showQrCode(type) {
            // Aquí puedes cambiar la URL del QR dependiendo del 'type' si tienes diferentes QRs
            // Por ahora, usamos un QR de ejemplo. ¡REEMPLAZA ESTO CON TU QR REAL!
            const dummyQrUrl = "https://i.ibb.co/4RC1fvGF/IMG-20251104-WA0001.jpg"; 
            qrCodeImage.src = dummyQrUrl;
            qrCodeContainer.style.display = 'block';
        }

        function payViaWhatsApp() {
            // ¡REEMPLAZA ESTE NÚMERO Y MENSAJE CON LOS TUYOS!
            const phoneNumber = "584128939324"; // Número de WhatsApp con código de país
            const message = encodeURIComponent("¡Hola! Quiero comprar la guía '30 Recetas de Postres Fríos en Vasos'.");
            window.open(`https://wa.me/${phoneNumber}?text=${message}`, '_blank');
        }

        // Cierra el modal si se hace clic fuera de él
        window.onclick = function(event) {
            if (event.target == paymentModal) {
                closePaymentModal();
            }
        }
    </script>
</body>
</html>
